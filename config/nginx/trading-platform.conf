upstream market_data {
    least_conn;
    server market-data-1:8081 max_fails=3 fail_timeout=30s;
    server market-data-2:8081 max_fails=3 fail_timeout=30s;
    server market-data-3:8081 max_fails=3 fail_timeout=30s;
}

upstream trading_engine {
    least_conn;
    server trading-engine-1:8082 max_fails=3 fail_timeout=30s;
    server trading-engine-2:8082 max_fails=3 fail_timeout=30s;
}

upstream strategy_engine {
    server strategy-engine:8083 max_fails=3 fail_timeout=30s;
}

upstream user_management {
    server user-management:8084 max_fails=3 fail_timeout=30s;
}

upstream risk_management {
    server risk-management:8085 max_fails=3 fail_timeout=30s;
}

upstream notification {
    server notification:8086 max_fails=3 fail_timeout=30s;
}

# Rate limiting
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=websocket:10m rate=50r/m;

server {
    listen 80;
    server_name trading-platform.local;
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # Market Data Service
    location /api/v1/market-data/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://market_data/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
        
        # Health check
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    }
    
    # WebSocket for real-time data
    location /ws/market-data {
        limit_req zone=websocket burst=10 nodelay;
        proxy_pass http://market_data;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket specific timeouts
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }
    
    # Trading Engine
    location /api/v1/trading/ {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://trading_engine/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Strategy Engine
    location /api/v1/strategies/ {
        limit_req zone=api burst=30 nodelay;
        proxy_pass http://strategy_engine/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # User Management
    location /api/v1/users/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://user_management/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Risk Management
    location /api/v1/risk/ {
        limit_req zone=api burst=40 nodelay;
        proxy_pass http://risk_management/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Notification Service
    location /api/v1/notifications/ {
        limit_req zone=api burst=15 nodelay;
        proxy_pass http://notification/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Health checks
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Monitoring endpoints
    location /metrics {
        allow 172.20.0.0/16;  # Only allow from Docker network
        deny all;
        proxy_pass http://market_data/metrics;
    }
    
    # Static files (if any)
    location /static/ {
        alias /var/www/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Default location
    location / {
        return 404;
    }
}