# 通知服务架构一致性规范

## 介绍

本规范旨在解决通知服务中存在的架构不一致问题，建立统一的概念模型、命名规范和分层架构，确保代码的可维护性和可扩展性。

## 术语表

- **NotificationChannel**: 通知渠道类型枚举（Email, Sms, Push, WebSocket, InApp, Webhook）
- **ChannelConfig**: 渠道配置实体，包含具体的渠道配置信息
- **ChannelService**: 渠道配置管理服务
- **ChannelStore**: 渠道配置数据存储层
- **Handler**: HTTP请求处理层
- **Service**: 业务逻辑服务层
- **Store**: 数据持久化存储层
- **Model**: 数据模型和领域对象

## 需求

### 需求 1: 统一概念模型

**用户故事**: 作为开发者，我希望整个通知服务使用统一的概念模型，以便代码易于理解和维护。

#### 验收标准

1. WHEN 开发者查看任何层的代码 THEN 系统应使用一致的术语来描述相同的概念
2. WHEN 开发者在不同层之间传递数据 THEN 系统应使用相同的类型名称和字段名称
3. WHEN 开发者添加新功能 THEN 系统应遵循已建立的命名约定
4. WHEN 开发者阅读API文档 THEN 系统应使用与代码中一致的术语
5. WHEN 开发者进行代码审查 THEN 系统应能够清晰地区分不同的概念层次

### 需求 2: 建立分层架构规范

**用户故事**: 作为架构师，我希望建立清晰的分层架构规范，以便各层职责明确且接口一致。

#### 验收标准

1. WHEN Handler层处理HTTP请求 THEN 系统应只调用Service层的方法，不直接访问Store层
2. WHEN Service层处理业务逻辑 THEN 系统应使用统一的方法命名规范
3. WHEN Store层进行数据操作 THEN 系统应使用统一的CRUD方法命名
4. WHEN 跨层传递数据 THEN 系统应使用明确定义的DTO和领域对象
5. WHEN 添加新的业务功能 THEN 系统应遵循既定的分层架构模式

### 需求 3: 统一方法命名规范

**用户故事**: 作为开发者，我希望所有CRUD操作使用统一的方法命名规范，以便代码具有可预测性。

#### 验收标准

1. WHEN 创建资源 THEN 系统应使用`create_*`方法命名模式
2. WHEN 获取单个资源 THEN 系统应使用`get_*`方法命名模式
3. WHEN 获取资源列表 THEN 系统应使用`list_*`方法命名模式
4. WHEN 更新资源 THEN 系统应使用`update_*`方法命名模式
5. WHEN 删除资源 THEN 系统应使用`delete_*`方法命名模式
6. WHEN 执行特殊操作 THEN 系统应使用描述性的动词命名（如`check_*_health`）

### 需求 4: 解决类型冲突和歧义

**用户故事**: 作为开发者，我希望解决现有的类型冲突和命名歧义，以便编译器能够正确识别类型。

#### 验收标准

1. WHEN 导入模型类型 THEN 系统应避免同名类型冲突（如ChannelMetrics）
2. WHEN 使用枚举类型 THEN 系统应提供完整的枚举值定义
3. WHEN 定义请求/响应类型 THEN 系统应使用清晰的命名区分不同用途
4. WHEN 编译代码 THEN 系统应无类型歧义错误
5. WHEN 使用IDE自动补全 THEN 系统应提供明确的类型提示

### 需求 5: 建立数据模型一致性

**用户故事**: 作为开发者，我希望数据模型在各层之间保持一致，以便数据传递无误。

#### 验收标准

1. WHEN 定义数据库表结构 THEN 系统应与Rust模型字段完全匹配
2. WHEN 序列化/反序列化数据 THEN 系统应使用一致的字段名称
3. WHEN 在不同层传递数据 THEN 系统应保持字段类型的一致性
4. WHEN 添加新字段 THEN 系统应同时更新所有相关层的定义
5. WHEN 进行数据验证 THEN 系统应在所有层使用相同的验证规则

### 需求 6: 建立错误处理一致性

**用户故事**: 作为开发者，我希望错误处理在各层之间保持一致，以便调试和维护。

#### 验收标准

1. WHEN 发生业务错误 THEN 系统应使用统一的错误类型和消息格式
2. WHEN 记录错误日志 THEN 系统应使用一致的日志级别和格式
3. WHEN 向客户端返回错误 THEN 系统应使用标准化的错误响应结构
4. WHEN 处理异步操作错误 THEN 系统应正确传播错误信息
5. WHEN 进行错误恢复 THEN 系统应遵循统一的重试和降级策略

### 需求 7: 建立接口契约规范

**用户故事**: 作为API使用者，我希望API接口遵循统一的契约规范，以便集成和使用。

#### 验收标准

1. WHEN 定义REST API端点 THEN 系统应遵循RESTful设计原则
2. WHEN 设计请求/响应格式 THEN 系统应使用一致的JSON结构
3. WHEN 处理HTTP状态码 THEN 系统应使用标准的状态码含义
4. WHEN 进行API版本管理 THEN 系统应支持向后兼容性
5. WHEN 生成API文档 THEN 系统应自动反映代码中的实际接口

### 需求 8: 建立测试一致性规范

**用户故事**: 作为质量保证工程师，我希望测试代码遵循一致的规范，以便测试覆盖完整且可维护。

#### 验收标准

1. WHEN 编写单元测试 THEN 系统应为每个Service方法提供对应的测试
2. WHEN 编写集成测试 THEN 系统应测试完整的请求-响应流程
3. WHEN 测试错误场景 THEN 系统应覆盖所有可能的错误路径
4. WHEN 运行测试 THEN 系统应提供清晰的测试结果和覆盖率报告
5. WHEN 重构代码 THEN 系统应确保测试仍然有效且通过