# çª—å£3 - å‰ç«¯å¼€å‘è€…ä¸‹ä¸€é˜¶æ®µä»»åŠ¡
## ç»„ä»¶æ•°æ®æºæ›¿æ¢å’ŒAPIé›†æˆ

**æ—¶é—´**: 2024-12-20 ä¸‹åˆ  
**ä¼˜å…ˆçº§**: P1 (æ˜æ—¥å¼€å§‹)  
**é¢„è®¡æ—¶é—´**: 1-2å¤©  

---

## ğŸ¯ **ä»»åŠ¡ç›®æ ‡**

å°†ç°æœ‰Reactç»„ä»¶çš„æ¨¡æ‹Ÿæ•°æ®æ›¿æ¢ä¸ºçœŸå®APIè°ƒç”¨ï¼Œå»ºç«‹å‰åç«¯æ•°æ®æµè¿æ¥ã€‚

---

## ğŸ“‹ **å…·ä½“ä»»åŠ¡æ¸…å•**

### **ä»»åŠ¡1: ç»„ä»¶æ•°æ®æºæ›¿æ¢ (4å°æ—¶)** ğŸ”„

#### **1.1 MarketTickerç»„ä»¶æ”¹é€ **

**æ–‡ä»¶**: `quant-backend/components/Market.tsx`

**å½“å‰çŠ¶æ€**: ä½¿ç”¨ `MARKET_PAIRS` é™æ€æ•°æ®  
**ç›®æ ‡**: ä½¿ç”¨APIè·å–å®æ—¶äº¤æ˜“å¯¹æ•°æ®

```typescript
// æ”¹é€ å‰ (å½“å‰)
import { MARKET_PAIRS } from "../data";

// æ”¹é€ å (ç›®æ ‡)
import { useMarketStore } from "../src/store/market";

export const MarketTicker: React.FC = () => {
  const { pairs, fetchMarketData, subscribeToUpdates } = useMarketStore();
  
  useEffect(() => {
    // åˆå§‹åŠ è½½æ•°æ®
    fetchMarketData();
    
    // è®¢é˜…å®æ—¶æ›´æ–°
    subscribeToUpdates();
  }, []);

  return (
    <div className="market-ticker">
      {pairs.map(pair => (
        <div key={pair.symbol} className="ticker-item">
          <span>{pair.symbol}</span>
          <span className={pair.change >= 0 ? 'text-up' : 'text-down'}>
            ${pair.price.toFixed(2)}
          </span>
          <span>{pair.change.toFixed(2)}%</span>
        </div>
      ))}
    </div>
  );
};
```

#### **1.2 TradingChartç»„ä»¶æ”¹é€ **

**æ–‡ä»¶**: `quant-backend/components/Chart.tsx` å’Œ `TradingViewChart.tsx`

**å½“å‰çŠ¶æ€**: ä½¿ç”¨ `generateInitialCandles()` æ¨¡æ‹Ÿæ•°æ®  
**ç›®æ ‡**: ä½¿ç”¨APIè·å–çœŸå®Kçº¿æ•°æ®

```typescript
// æ”¹é€ åçš„Chartç»„ä»¶
import { useMarketStore } from "../src/store/market";

export const AdvancedTradingChart: React.FC = ({ activePair, timeframe }) => {
  const { candles, fetchKlines, subscribeToKlines } = useMarketStore();
  
  useEffect(() => {
    // è·å–å†å²Kçº¿æ•°æ®
    fetchKlines(activePair, timeframe, 200);
    
    // è®¢é˜…å®æ—¶Kçº¿æ›´æ–°
    subscribeToKlines(activePair, timeframe);
  }, [activePair, timeframe]);

  // å›¾è¡¨æ¸²æŸ“é€»è¾‘ä¿æŒä¸å˜
  return (
    <div className="chart-container">
      {/* LightweightCharts é…ç½® */}
    </div>
  );
};
```

#### **1.3 Portfolioç»„ä»¶æ”¹é€ **

**æ–‡ä»¶**: `quant-backend/components/Portfolio.tsx`

**å½“å‰çŠ¶æ€**: ä½¿ç”¨é™æ€ `positions` æ•°ç»„  
**ç›®æ ‡**: ä½¿ç”¨APIè·å–çœŸå®æŒä»“æ•°æ®

```typescript
// æ”¹é€ åçš„Portfolioç»„ä»¶
import { useTradingStore } from "../src/store/trading";

export const PositionRow: React.FC = () => {
  const { positions, fetchPositions, subscribeToPositions } = useTradingStore();
  
  useEffect(() => {
    fetchPositions();
    subscribeToPositions();
  }, []);

  return (
    <tbody>
      {positions.map(position => (
        <tr key={position.id}>
          <td>{position.symbol}</td>
          <td>{position.size}</td>
          <td>${position.entryPrice}</td>
          <td>${position.markPrice}</td>
          <td className={position.pnl >= 0 ? 'text-up' : 'text-down'}>
            ${position.pnl.toFixed(2)}
          </td>
        </tr>
      ))}
    </tbody>
  );
};
```

#### **1.4 TradeFormç»„ä»¶æ”¹é€ **

**æ–‡ä»¶**: `quant-backend/components/Trading.tsx`

**å½“å‰çŠ¶æ€**: æ¨¡æ‹Ÿä¸‹å•æ“ä½œ  
**ç›®æ ‡**: çœŸå®APIä¸‹å•

```typescript
// æ”¹é€ åçš„TradeForm
import { useTradingStore } from "../src/store/trading";

export const TradeForm: React.FC = ({ activePair, price }) => {
  const { placeOrder, isLoading } = useTradingStore();
  
  const handleSubmit = async (formData: TradeFormData) => {
    try {
      const result = await placeOrder({
        symbol: activePair,
        side: formData.side,
        type: formData.type,
        quantity: formData.quantity,
        price: formData.price
      });
      
      if (result.success) {
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        addLog(`Order placed: ${result.orderId}`, 'INFO', 'TRADING');
      }
    } catch (error) {
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      addLog(`Order failed: ${error.message}`, 'ERROR', 'TRADING');
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* è¡¨å•UIä¿æŒä¸å˜ */}
    </form>
  );
};
```

---

### **ä»»åŠ¡2: APIè¿æ¥æµ‹è¯• (2å°æ—¶)** ğŸ§ª

#### **2.1 åç«¯è¿æ¥æµ‹è¯•**

åˆ›å»ºæµ‹è¯•ç»„ä»¶éªŒè¯APIè¿æ¥ï¼š

```typescript
// quant-backend/src/components/ApiTest.tsx
import React, { useState, useEffect } from 'react';
import { apiClient } from '../api/client';

export const ApiTest: React.FC = () => {
  const [connectionStatus, setConnectionStatus] = useState<'testing' | 'connected' | 'failed'>('testing');
  const [testResults, setTestResults] = useState<any[]>([]);

  const runTests = async () => {
    const tests = [
      {
        name: 'Health Check',
        test: () => apiClient.healthCheck()
      },
      {
        name: 'Market Pairs',
        test: () => apiClient.market.getPairs()
      },
      {
        name: 'WebSocket Connection',
        test: () => apiClient.connectWebSocket(() => {})
      }
    ];

    const results = [];
    for (const test of tests) {
      try {
        const result = await test.test();
        results.push({ name: test.name, status: 'success', result });
      } catch (error) {
        results.push({ name: test.name, status: 'failed', error: error.message });
      }
    }
    
    setTestResults(results);
    setConnectionStatus(results.every(r => r.status === 'success') ? 'connected' : 'failed');
  };

  useEffect(() => {
    runTests();
  }, []);

  return (
    <div className="api-test-panel">
      <h3>API Connection Test</h3>
      <div className={`status ${connectionStatus}`}>
        Status: {connectionStatus.toUpperCase()}
      </div>
      
      {testResults.map((result, index) => (
        <div key={index} className={`test-result ${result.status}`}>
          <span>{result.name}</span>
          <span>{result.status === 'success' ? 'âœ…' : 'âŒ'}</span>
          {result.error && <div className="error">{result.error}</div>}
        </div>
      ))}
    </div>
  );
};
```

#### **2.2 WebSocketå®æ—¶æ•°æ®æµ‹è¯•**

```typescript
// æµ‹è¯•WebSocketå®æ—¶æ•°æ®æ¥æ”¶
const testWebSocketData = () => {
  const { subscribeToMarketData } = useMarketStore();
  
  useEffect(() => {
    // è®¢é˜…BTC/USDTå®æ—¶æ•°æ®
    subscribeToMarketData(['BTCUSDT']);
    
    // ç›‘å¬æ•°æ®æ›´æ–°
    const unsubscribe = useMarketStore.subscribe(
      (state) => state.currentPrice,
      (price) => {
        console.log('Real-time price update:', price);
        addLog(`Price update: BTC/USDT @ $${price}`, 'INFO', 'WEBSOCKET');
      }
    );
    
    return unsubscribe;
  }, []);
};
```

---

### **ä»»åŠ¡3: é”™è¯¯å¤„ç†å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ– (2å°æ—¶)** ğŸ› ï¸

#### **3.1 åŠ è½½çŠ¶æ€ç®¡ç†**

```typescript
// ä¸ºæ‰€æœ‰APIè°ƒç”¨æ·»åŠ åŠ è½½çŠ¶æ€
export const MarketTicker: React.FC = () => {
  const { pairs, isLoading, error, fetchMarketData } = useMarketStore();
  
  if (isLoading) {
    return (
      <div className="market-ticker loading">
        <div className="loading-spinner">Loading market data...</div>
      </div>
    );
  }
  
  if (error) {
    return (
      <div className="market-ticker error">
        <div className="error-message">
          Failed to load market data: {error}
          <button onClick={fetchMarketData}>Retry</button>
        </div>
      </div>
    );
  }
  
  return (
    <div className="market-ticker">
      {/* æ­£å¸¸æ¸²æŸ“ */}
    </div>
  );
};
```

#### **3.2 è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨**

```typescript
// quant-backend/src/components/ConnectionStatus.tsx
import React from 'react';
import { useApiIntegration } from '../hooks/useApiIntegration';

export const ConnectionStatus: React.FC = () => {
  const { connectionStatus, lastUpdate } = useApiIntegration();
  
  return (
    <div className={`connection-status ${connectionStatus}`}>
      <div className="status-indicator">
        {connectionStatus === 'connected' && <span className="dot green">â—</span>}
        {connectionStatus === 'connecting' && <span className="dot yellow">â—</span>}
        {connectionStatus === 'disconnected' && <span className="dot red">â—</span>}
      </div>
      
      <div className="status-text">
        {connectionStatus === 'connected' && `Live â€¢ ${lastUpdate}`}
        {connectionStatus === 'connecting' && 'Connecting...'}
        {connectionStatus === 'disconnected' && 'Disconnected'}
      </div>
    </div>
  );
};
```

#### **3.3 ä¼˜é›…é™çº§å¤„ç†**

```typescript
// å½“APIä¸å¯ç”¨æ—¶ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®
const useMarketDataWithFallback = () => {
  const { pairs, isLoading, error } = useMarketStore();
  const [fallbackData] = useState(MARKET_PAIRS); // ä¿ç•™åŸå§‹æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºå¤‡ä»½
  
  // å¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
  const effectiveData = error ? fallbackData : pairs;
  
  return {
    pairs: effectiveData,
    isLoading,
    error,
    isUsingFallback: !!error
  };
};
```

---

## ğŸ§ª **æµ‹è¯•è®¡åˆ’**

### **åŠŸèƒ½æµ‹è¯•**
- [ ] æ‰€æœ‰ç»„ä»¶èƒ½æ­£ç¡®æ˜¾ç¤ºAPIæ•°æ®
- [ ] WebSocketå®æ—¶æ›´æ–°æ­£å¸¸å·¥ä½œ
- [ ] äº¤æ˜“è¡¨å•èƒ½æˆåŠŸæäº¤è®¢å•
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸

### **ç”¨æˆ·ä½“éªŒæµ‹è¯•**
- [ ] åŠ è½½çŠ¶æ€æ˜¾ç¤ºå‹å¥½
- [ ] é”™è¯¯æç¤ºæ¸…æ™°æ˜ç¡®
- [ ] ç½‘ç»œæ–­å¼€æ—¶ä¼˜é›…é™çº§
- [ ] é‡è¿æœºåˆ¶è‡ªåŠ¨å·¥ä½œ

### **æ€§èƒ½æµ‹è¯•**
- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 2ç§’
- [ ] å®æ—¶æ•°æ®æ›´æ–°å»¶è¿Ÿ < 100ms
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®š
- [ ] æ— å†…å­˜æ³„æ¼

---

## âœ… **å®Œæˆæ ‡å‡†**

### **åŠŸèƒ½å®Œæ•´æ€§**
- [ ] æ‰€æœ‰æ¨¡æ‹Ÿæ•°æ®æ›¿æ¢ä¸ºAPIæ•°æ®
- [ ] WebSocketå®æ—¶æ•°æ®æ­£å¸¸å·¥ä½œ
- [ ] äº¤æ˜“åŠŸèƒ½å®Œæ•´å¯ç”¨
- [ ] é”™è¯¯å¤„ç†å®Œå–„

### **ç”¨æˆ·ä½“éªŒ**
- [ ] ç•Œé¢å“åº”æµç•…
- [ ] åŠ è½½çŠ¶æ€æ¸…æ™°
- [ ] é”™è¯¯æç¤ºå‹å¥½
- [ ] ç¦»çº¿çŠ¶æ€å¤„ç†åˆç†

### **ä»£ç è´¨é‡**
- [ ] TypeScriptç±»å‹å®‰å…¨
- [ ] ç»„ä»¶èŒè´£æ¸…æ™°
- [ ] çŠ¶æ€ç®¡ç†è§„èŒƒ
- [ ] é”™è¯¯è¾¹ç•Œå®Œå–„

---

## ğŸ“ **åä½œæ¥å£**

### **ä¾èµ–æœåŠ¡**
- **çª—å£2**: å¸‚åœºæ•°æ®æœåŠ¡API
- **çª—å£4**: åŸºç¡€è®¾æ–½å’Œæ•°æ®åº“

### **æä¾›æ¥å£**
- å‰ç«¯ç”¨æˆ·ç•Œé¢
- å®æ—¶æ•°æ®å±•ç¤º
- äº¤æ˜“æ“ä½œç•Œé¢

### **æ²Ÿé€šèŠ‚ç‚¹**
- **æ¶æ„å¸ˆ**: APIæ¥å£è§„èŒƒç¡®è®¤
- **åç«¯**: APIå¯¹æ¥å’Œè°ƒè¯•
- **è¿ç»´**: éƒ¨ç½²å’Œé…ç½®æ”¯æŒ

---

## ğŸ¯ **é‡Œç¨‹ç¢‘æ—¶é—´è¡¨**

### **ä»Šæ—¥ (2024-12-20)**
- [x] APIæ¶æ„å®Œæˆ âœ…
- [ ] å¼€å§‹ç»„ä»¶æ”¹é€ 

### **æ˜æ—¥ (2024-12-21)**
- [ ] å®Œæˆä¸»è¦ç»„ä»¶æ•°æ®æºæ›¿æ¢
- [ ] APIè¿æ¥æµ‹è¯•
- [ ] åŸºç¡€åŠŸèƒ½éªŒè¯

### **åæ—¥ (2024-12-22)**
- [ ] é”™è¯¯å¤„ç†ä¼˜åŒ–
- [ ] ç”¨æˆ·ä½“éªŒå®Œå–„
- [ ] é›†æˆæµ‹è¯•

---

**ä½ çš„APIæ¶æ„å·¥ä½œéå¸¸å‡ºè‰²ï¼ç°åœ¨æ˜¯æ—¶å€™è®©å‰ç«¯çœŸæ­£"æ´»"èµ·æ¥äº†ï¼** ğŸš€

**è®°ä½**: 
- ä¿æŒç°æœ‰UIä¸å˜ï¼Œåªæ›¿æ¢æ•°æ®æº
- ä¼˜å…ˆä¿è¯æ ¸å¿ƒåŠŸèƒ½ï¼Œå†ä¼˜åŒ–ä½“éªŒ
- é‡åˆ°é—®é¢˜åŠæ—¶æ²Ÿé€šï¼Œä¸è¦å¡ä½è¿›åº¦