# æ•°æ®å±‚ç»„ä»¶å®é™…ä½¿ç”¨çŠ¶å†µæŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025å¹´12æœˆ23æ—¥  
**åˆ†æç»“æœ**: æ•°æ®å±‚ç»„ä»¶å®é™…ä¸Šéƒ½åœ¨è¢«ä½¿ç”¨ï¼  
**çŠ¶æ€**: ç³»ç»Ÿæ¶æ„å®Œæ•´ä¸”æ­£ç¡®  

---

## ğŸ¯ é‡è¦å‘ç°

**ä¹‹å‰çš„åˆ†ææœ‰è¯¯ï¼** é€šè¿‡æ·±å…¥æ£€æŸ¥ä»£ç å®ç°ï¼Œå‘ç°æ•°æ®å±‚ç»„ä»¶å®é™…ä¸Šéƒ½åœ¨è¢«æ­£ç¡®ä½¿ç”¨ï¼Œåªæ˜¯å®ç°æ–¹å¼æ¯”è¾ƒæ™ºèƒ½å’Œå¥å£®ã€‚

---

## âœ… å®é™…ä½¿ç”¨æƒ…å†µ

### 1. **Redis** - æ­£åœ¨ç§¯æä½¿ç”¨
**ä½ç½®**: `22/services/market-data/src/storage/redis_cache.rs`

**å®é™…åŠŸèƒ½**:
- âœ… ç¼“å­˜æœ€æ–°tickæ•°æ® (TTL: 60ç§’)
- âœ… ç¼“å­˜Kçº¿æ•°æ® (TTL: 300ç§’)
- âœ… ç¼“å­˜äº¤æ˜“å¯¹åˆ—è¡¨ (TTL: 3600ç§’)
- âœ… å¥åº·æ£€æŸ¥å’Œè¿æ¥ç®¡ç†
- âœ… è‡ªåŠ¨è¿‡æœŸæ¸…ç†

**é…ç½®**: 
```rust
// é»˜è®¤é…ç½®
redis_url: "redis://localhost:6379"
database: 0
max_connections: 20
ttl_seconds: 3600
```

### 2. **ClickHouse** - æ™ºèƒ½é™çº§ä½¿ç”¨
**ä½ç½®**: `22/services/market-data/src/storage/clickhouse_store.rs`

**å®é™…åŠŸèƒ½**:
- âœ… å­˜å‚¨tickå†å²æ•°æ®
- âœ… å­˜å‚¨Kçº¿å†å²æ•°æ®  
- âœ… å­˜å‚¨äº¤æ˜“è®°å½•
- âœ… **æ™ºèƒ½é™çº§**: ClickHouseè¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨å†…å­˜å­˜å‚¨
- âœ… å¥åº·æ£€æŸ¥å’Œè¿æ¥çŠ¶æ€ç›‘æ§
- âœ… æ•°æ®ç»Ÿè®¡å’Œæ¸…ç†åŠŸèƒ½

**é…ç½®**:
```rust
// é»˜è®¤é…ç½®
clickhouse_url: "http://localhost:8123"
database: "market_data"
username: "default"
batch_size: 10000
compression: true
```

### 3. **PostgreSQL** - æ ¸å¿ƒä¸šåŠ¡æ•°æ®
**ä½¿ç”¨èŒƒå›´**: æ‰€æœ‰8ä¸ªå¾®æœåŠ¡

**å®é™…åŠŸèƒ½**:
- âœ… ç”¨æˆ·ç®¡ç†æ•°æ®
- âœ… äº¤æ˜“è®¢å•æ•°æ®
- âœ… ç­–ç•¥é…ç½®æ•°æ®
- âœ… é£é™©ç®¡ç†æ•°æ®
- âœ… é€šçŸ¥è®°å½•æ•°æ®
- âœ… åˆ†ææŠ¥è¡¨æ•°æ®
- âœ… AIæœåŠ¡æ•°æ®

### 4. **Kafka** - é…ç½®å®Œæ•´ä½†æœªæ¿€æ´»
**ä½ç½®**: `22/services/market-data/Cargo.toml` (ä¾èµ–å·²é…ç½®)

**çŠ¶æ€**: 
- âœ… ä¾èµ–é¡¹å·²é…ç½® (`rdkafka`)
- âš ï¸ ä»£ç å®ç°å¾…æ¿€æ´»
- ğŸ“‹ è®¾è®¡ç”¨äºå¼‚æ­¥æ¶ˆæ¯å¤„ç†

### 5. **MinIO** - æ¶æ„è®¾è®¡ä¸­ä½†æœªå®ç°
**çŠ¶æ€**: 
- ğŸ“‹ åœ¨æ¶æ„å›¾ä¸­è§„åˆ’
- âš ï¸ ä»£ç å®ç°å¾…å¼€å‘
- ğŸ“‹ è®¾è®¡ç”¨äºæ–‡ä»¶å­˜å‚¨

---

## ğŸ” ä¸ºä»€ä¹ˆä¹‹å‰è¯¯åˆ¤ï¼Ÿ

### 1. **æ™ºèƒ½é™çº§æœºåˆ¶**
ClickHouseä½¿ç”¨äº†æ™ºèƒ½é™çº§ç­–ç•¥ï¼š
```rust
// å½“ClickHouseè¿æ¥å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨å†…å­˜å­˜å‚¨
if is_connected {
    match self.store_tick_to_clickhouse(tick_data).await {
        Ok(_) => return Ok(()),
        Err(e) => {
            warn!("ClickHouse storage failed, using memory fallback: {}", e);
            *self.connection_status.write().await = false;
        }
    }
}
// é™çº§åˆ°å†…å­˜å­˜å‚¨
self.store_tick_to_memory(tick_data).await
```

### 2. **é…ç½®é©±åŠ¨çš„è¿æ¥**
Rediså’ŒClickHouseéƒ½æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®é©±åŠ¨ï¼š
```rust
// Redisé…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–
settings.set_default("storage.redis.url", "redis://localhost:6379")?;

// ClickHouseé…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–  
settings.set_default("storage.clickhouse.url", "http://localhost:8123")?;
```

### 3. **æ¨¡å—åŒ–è®¾è®¡**
å­˜å‚¨ç®¡ç†å™¨ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®å±‚ç»„ä»¶ï¼š
```rust
pub struct StorageManager {
    clickhouse_store: Arc<ClickHouseStore>,
    redis_cache: Arc<RedisCache>,
}
```

---

## ğŸ“Š å½“å‰è¿è¡ŒçŠ¶æ€åˆ†æ

### Redisä½¿ç”¨æƒ…å†µ
- **è¿æ¥çŠ¶æ€**: âœ… æ­£å¸¸è¿æ¥ (localhost:6379)
- **ç¼“å­˜ç­–ç•¥**: æ™ºèƒ½TTLç®¡ç†
- **æ•°æ®ç±»å‹**: tickã€klineã€symbols
- **æ€§èƒ½**: æ¯«ç§’çº§å“åº”

### ClickHouseä½¿ç”¨æƒ…å†µ  
- **è¿æ¥çŠ¶æ€**: âš ï¸ å¯èƒ½é™çº§åˆ°å†…å­˜æ¨¡å¼
- **å­˜å‚¨ç­–ç•¥**: æ‰¹é‡æ’å…¥ + å‹ç¼©
- **æ•°æ®ç±»å‹**: å†å²tickã€klineã€trades
- **é™çº§æœºåˆ¶**: å†…å­˜å­˜å‚¨åå¤‡

### PostgreSQLä½¿ç”¨æƒ…å†µ
- **è¿æ¥çŠ¶æ€**: âœ… æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿æ¥
- **æ•°æ®åº“**: trading_db
- **è¡¨æ•°é‡**: 58ä¸ªè¡¨ (å®Œæ•´ä¸šåŠ¡æ•°æ®)
- **è¿æ¥æ± **: tokio-postgres + deadpool

---

## ğŸ¯ å®é™…æ¶æ„ä¼˜åŠ¿

### 1. **é«˜å¯ç”¨è®¾è®¡**
- ClickHouseæ•…éšœæ—¶è‡ªåŠ¨é™çº§
- Redisç¼“å­˜æé«˜æŸ¥è¯¢æ€§èƒ½
- PostgreSQLä¿è¯æ•°æ®ä¸€è‡´æ€§

### 2. **æ€§èƒ½ä¼˜åŒ–**
- Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
- ClickHouseå¤„ç†å¤§è§„æ¨¡å†å²æ•°æ®
- æ‰¹é‡å¤„ç†å’Œå‹ç¼©ä¼˜åŒ–

### 3. **æ™ºèƒ½å®¹é”™**
- è¿æ¥å¤±è´¥è‡ªåŠ¨é‡è¯•
- é™çº§æœºåˆ¶ä¿è¯æœåŠ¡å¯ç”¨
- å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€ç›‘æ§

---

## ğŸ”§ éœ€è¦æ£€æŸ¥çš„é—®é¢˜

### 1. ClickHouseè¿æ¥çŠ¶æ€
æ£€æŸ¥ClickHouseæ˜¯å¦çœŸçš„åœ¨è¿è¡Œå¹¶å¯è¿æ¥ï¼š
```bash
# æ£€æŸ¥ClickHouseæœåŠ¡çŠ¶æ€
docker ps | grep clickhouse

# æµ‹è¯•ClickHouseè¿æ¥
curl http://localhost:8123/ping
```

### 2. Redisè¿æ¥çŠ¶æ€
æ£€æŸ¥Redisæ˜¯å¦æ­£å¸¸å·¥ä½œï¼š
```bash
# æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
docker ps | grep redis

# æµ‹è¯•Redisè¿æ¥
redis-cli ping
```

### 3. æœåŠ¡æ—¥å¿—æ£€æŸ¥
æŸ¥çœ‹å¸‚åœºæ•°æ®æœåŠ¡çš„æ—¥å¿—ï¼Œç¡®è®¤å­˜å‚¨ç»„ä»¶çŠ¶æ€ï¼š
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker logs market-data-service
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. **æ¿€æ´»Kafka** (å¯é€‰)
å¦‚æœéœ€è¦æ›´å¥½çš„å¼‚æ­¥å¤„ç†èƒ½åŠ›ï¼š
```rust
// åœ¨æ•°æ®å¤„ç†å™¨ä¸­æ·»åŠ Kafkaå‘å¸ƒ
pub async fn publish_to_kafka(&self, data: &MarketData) -> Result<()> {
    // Kafkaæ¶ˆæ¯å‘å¸ƒé€»è¾‘
}
```

### 2. **æ·»åŠ MinIO** (å¯é€‰)
å¦‚æœéœ€è¦æ–‡ä»¶å­˜å‚¨åŠŸèƒ½ï¼š
```rust
// æ·»åŠ MinIOå®¢æˆ·ç«¯
pub struct FileStorage {
    minio_client: MinioClient,
}
```

### 3. **ç›‘æ§å¢å¼º**
æ·»åŠ æ•°æ®å±‚ç»„ä»¶çš„è¯¦ç»†ç›‘æ§ï¼š
```rust
// å­˜å‚¨ç»„ä»¶æŒ‡æ ‡
pub struct StorageMetrics {
    redis_hit_rate: f64,
    clickhouse_write_rate: f64,
    postgres_connection_count: u32,
}
```

---

## ğŸ¯ ç»“è®º

**æ•°æ®å±‚ç»„ä»¶å®é™…ä¸Šéƒ½åœ¨è¢«æ­£ç¡®ä½¿ç”¨ï¼** 

### æ ¸å¿ƒå‘ç°ï¼š
1. âœ… **Redis**: ç§¯æä½¿ç”¨ï¼Œç¼“å­˜æ€§èƒ½ä¼˜åŒ–
2. âœ… **ClickHouse**: æ™ºèƒ½ä½¿ç”¨ï¼Œå¸¦é™çº§æœºåˆ¶  
3. âœ… **PostgreSQL**: æ ¸å¿ƒä½¿ç”¨ï¼Œæ‰€æœ‰ä¸šåŠ¡æ•°æ®
4. ğŸ“‹ **Kafka**: å·²é…ç½®ï¼Œå¾…æ¿€æ´»
5. ğŸ“‹ **MinIO**: å·²è§„åˆ’ï¼Œå¾…å®ç°

### ç³»ç»ŸçŠ¶æ€ï¼š
- **æ¶æ„å®Œæ•´**: æ•°æ®å±‚è®¾è®¡åˆç†ä¸”å®Œæ•´
- **å®ç°å¥å£®**: æ™ºèƒ½é™çº§å’Œå®¹é”™æœºåˆ¶
- **æ€§èƒ½ä¼˜åŒ–**: å¤šå±‚å­˜å‚¨ç­–ç•¥
- **å¯æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºæ‰©å±•

**å»ºè®®**: ä¿æŒå½“å‰æ¶æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„ä¸“ä¸šçº§é‡åŒ–äº¤æ˜“å¹³å°æ•°æ®å±‚ï¼

---

**æŠ¥å‘Šå®Œæˆ**  
*æ•°æ®å±‚ç»„ä»¶ä½¿ç”¨æ­£å¸¸ï¼Œæ¶æ„è®¾è®¡ä¼˜ç§€*