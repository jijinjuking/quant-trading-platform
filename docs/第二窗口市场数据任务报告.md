# çª—å£2: å¸‚åœºæ•°æ®ä¸“å®¶ä»»åŠ¡æ¸…å•
## Market Data Service ä¸“ä¸šå¼€å‘

**è§’è‰²**: å¸‚åœºæ•°æ®å·¥ç¨‹å¸ˆ  
**ä¸“æ³¨æœåŠ¡**: Market Data Service (ç«¯å£8081)  
**æ ¸å¿ƒæŠ€èƒ½**: Rust + WebSocket + æ—¶åºæ•°æ®åº“  

---

## ğŸ¯ **æœåŠ¡èŒè´£**

### **æ ¸å¿ƒåŠŸèƒ½**
- å¤šäº¤æ˜“æ‰€å®æ—¶æ•°æ®é‡‡é›† (Binanceä¼˜å…ˆ)
- æ•°æ®æ ‡å‡†åŒ–å’Œæ¸…æ´—å¤„ç†
- ClickHouseæ—¶åºæ•°æ®å­˜å‚¨
- Rediså®æ—¶æ•°æ®ç¼“å­˜
- WebSocketæ•°æ®åˆ†å‘

### **æŠ€æœ¯æ ˆ**
- **è¯­è¨€**: Rust (å¼‚æ­¥ç¼–ç¨‹)
- **WebSocket**: tokio-tungstenite
- **æ•°æ®åº“**: ClickHouse + Redis
- **æ¶ˆæ¯é˜Ÿåˆ—**: Kafka
- **ç›‘æ§**: Prometheus metrics

---

## ğŸ“‹ **ä»Šæ—¥ä»»åŠ¡ (P0ä¼˜å…ˆçº§)**

### **1. ç´§æ€¥ä¿®å¤ç¼–è¯‘é”™è¯¯ (9:00-12:00)** âš¡
**çŠ¶æ€**: å·²å®Œæˆ60%ï¼Œéœ€è¦å®Œå–„å…·ä½“å®ç°

**å¾…å®Œæˆæ–‡ä»¶**:
```rust
// éœ€è¦å®ç°çš„å…·ä½“ç»“æ„
22/services/market-data/src/storage/clickhouse_store.rs
22/services/market-data/src/storage/redis_cache.rs
22/services/market-data/src/processors/tick_processor.rs
22/services/market-data/src/processors/kline_processor.rs
```

**å®ç°è¦æ±‚**:
- [ ] ClickHouseStore: æ—¶åºæ•°æ®å†™å…¥å’ŒæŸ¥è¯¢
- [ ] RedisCache: å®æ—¶ä»·æ ¼ç¼“å­˜å’Œè®¢é˜…
- [ ] TickProcessor: Tickæ•°æ®æ ‡å‡†åŒ–å¤„ç†
- [ ] KlineProcessor: Kçº¿æ•°æ®èšåˆè®¡ç®—

### **2. Binance WebSocketè¿æ¥å™¨ (13:00-17:00)** ğŸ”„
**ç›®æ ‡**: å®Œæˆå®æ—¶æ•°æ®æ¥æ”¶

**å…·ä½“ä»»åŠ¡**:
- [ ] å®Œå–„ `connectors/binance.rs` WebSocketè¿æ¥
- [ ] å®ç°è‡ªåŠ¨é‡è¿å’Œé”™è¯¯å¤„ç†
- [ ] æ·»åŠ æ•°æ®è®¢é˜…ç®¡ç† (ticker, kline, trades)
- [ ] å®ç°æ•°æ®æ ‡å‡†åŒ–è½¬æ¢

**æŠ€æœ¯è¦ç‚¹**:
```rust
// WebSocketè¿æ¥ç¤ºä¾‹
impl BinanceConnector {
    pub async fn connect_stream(&self) -> Result<WebSocketStream> {
        // å®ç°WebSocketè¿æ¥
    }
    
    pub async fn subscribe_ticker(&self, symbol: &str) -> Result<()> {
        // è®¢é˜…å®æ—¶ä»·æ ¼
    }
    
    pub async fn handle_message(&self, msg: Message) -> Result<MarketData> {
        // å¤„ç†å’Œæ ‡å‡†åŒ–æ•°æ®
    }
}
```

### **3. æ•°æ®æµç®¡é“æµ‹è¯• (17:00-18:00)** ğŸ§ª
- [ ] ç¼–è¯‘æµ‹è¯•é€šè¿‡
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™
- [ ] é›†æˆæµ‹è¯• (WebSocket â†’ å¤„ç† â†’ å­˜å‚¨)
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

---

## ğŸ”§ **æŠ€æœ¯å®ç°æŒ‡å—**

### **ClickHouseå­˜å‚¨å®ç°**
```rust
pub struct ClickHouseStore {
    client: clickhouse::Client,
    config: MarketDataConfig,
}

impl ClickHouseStore {
    pub async fn store_ticks(&self, ticks: Vec<MarketTick>) -> Result<()> {
        // æ‰¹é‡å†™å…¥Tickæ•°æ®
    }
    
    pub async fn store_klines(&self, klines: Vec<Kline>) -> Result<()> {
        // æ‰¹é‡å†™å…¥Kçº¿æ•°æ®
    }
    
    pub async fn query_klines(&self, symbol: &str, interval: &str, limit: u32) -> Result<Vec<Kline>> {
        // æŸ¥è¯¢å†å²Kçº¿æ•°æ®
    }
}
```

### **Redisç¼“å­˜å®ç°**
```rust
pub struct RedisCache {
    client: redis::Client,
    connection: redis::aio::Connection,
}

impl RedisCache {
    pub async fn cache_price(&self, symbol: &str, price: Decimal) -> Result<()> {
        // ç¼“å­˜å®æ—¶ä»·æ ¼
    }
    
    pub async fn get_price(&self, symbol: &str) -> Result<Option<Decimal>> {
        // è·å–ç¼“å­˜ä»·æ ¼
    }
    
    pub async fn publish_update(&self, channel: &str, data: &str) -> Result<()> {
        // å‘å¸ƒå®æ—¶æ›´æ–°
    }
}
```

### **æ•°æ®å¤„ç†å™¨å®ç°**
```rust
pub struct TickProcessor {
    metrics: Arc<AppMetrics>,
}

impl TickProcessor {
    pub async fn process(&self, raw_tick: RawTick) -> Result<MarketTick> {
        // 1. æ•°æ®éªŒè¯
        // 2. æ ¼å¼æ ‡å‡†åŒ–
        // 3. å¼‚å¸¸æ£€æµ‹
        // 4. æŒ‡æ ‡æ›´æ–°
    }
}
```

---

## ğŸ“Š **æ•°æ®ç»“æ„è®¾è®¡**

### **æ ‡å‡†åŒ–æ•°æ®æ¨¡å‹**
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MarketTick {
    pub exchange: String,
    pub symbol: String,
    pub timestamp: DateTime<Utc>,
    pub price: Decimal,
    pub volume: Decimal,
    pub side: OrderSide,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Kline {
    pub exchange: String,
    pub symbol: String,
    pub interval: String,
    pub open_time: DateTime<Utc>,
    pub close_time: DateTime<Utc>,
    pub open: Decimal,
    pub high: Decimal,
    pub low: Decimal,
    pub close: Decimal,
    pub volume: Decimal,
}
```

### **APIæ¥å£è§„èŒƒ**
```rust
// GET /api/v1/market/pairs
pub async fn get_pairs() -> Result<Json<MarketPairsResponse>>;

// GET /api/v1/market/ticker/:symbol
pub async fn get_ticker(symbol: String) -> Result<Json<TickerResponse>>;

// GET /api/v1/market/klines/:symbol?interval=15m&limit=200
pub async fn get_klines(symbol: String, params: KlineParams) -> Result<Json<KlinesResponse>>;

// WebSocket /ws/market
pub async fn websocket_handler(ws: WebSocketUpgrade) -> Response;
```

---

## ğŸ§ª **æµ‹è¯•è¦æ±‚**

### **å•å…ƒæµ‹è¯•**
- [ ] æ•°æ®å¤„ç†å™¨é€»è¾‘æµ‹è¯•
- [ ] å­˜å‚¨å±‚æ¥å£æµ‹è¯•
- [ ] WebSocketè¿æ¥æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•

### **é›†æˆæµ‹è¯•**
- [ ] Binance WebSocketè¿æ¥æµ‹è¯•
- [ ] ClickHouseæ•°æ®å†™å…¥æµ‹è¯•
- [ ] Redisç¼“å­˜åŠŸèƒ½æµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æ•°æ®æµæµ‹è¯•

### **æ€§èƒ½æµ‹è¯•**
- [ ] æ•°æ®å¤„ç†ååé‡: >10000 msg/s
- [ ] WebSocketå»¶è¿Ÿ: <10ms
- [ ] æ•°æ®åº“å†™å…¥æ€§èƒ½: >1000 TPS
- [ ] å†…å­˜ä½¿ç”¨ä¼˜åŒ–

---

## ğŸ“ˆ **ç›‘æ§æŒ‡æ ‡**

### **ä¸šåŠ¡æŒ‡æ ‡**
```rust
// PrometheusæŒ‡æ ‡å®šä¹‰
pub struct MarketDataMetrics {
    pub messages_received: Counter,
    pub messages_processed: Counter,
    pub processing_duration: Histogram,
    pub websocket_connections: Gauge,
    pub database_writes: Counter,
    pub cache_hits: Counter,
}
```

### **å…³é”®ç›‘æ§**
- WebSocketè¿æ¥çŠ¶æ€
- æ•°æ®å¤„ç†å»¶è¿Ÿ
- æ•°æ®åº“å†™å…¥æˆåŠŸç‡
- ç¼“å­˜å‘½ä¸­ç‡
- é”™è¯¯ç‡å’Œå¼‚å¸¸

---

## ğŸš¨ **å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**

### **WebSocketè¿æ¥é—®é¢˜**
```rust
// é‡è¿æœºåˆ¶
pub async fn handle_reconnect(&self) -> Result<()> {
    let mut retry_count = 0;
    let max_retries = 5;
    
    while retry_count < max_retries {
        match self.connect().await {
            Ok(_) => return Ok(()),
            Err(e) => {
                retry_count += 1;
                let delay = Duration::from_secs(2_u64.pow(retry_count));
                tokio::time::sleep(delay).await;
            }
        }
    }
}
```

### **æ•°æ®è´¨é‡é—®é¢˜**
- ä»·æ ¼å¼‚å¸¸æ£€æµ‹ (åç¦»é˜ˆå€¼)
- æ—¶é—´æˆ³éªŒè¯ (é˜²æ­¢é‡å¤å’Œä¹±åº)
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- äº¤æ˜“æ‰€APIé™æµå¤„ç†

---

## âœ… **ä»Šæ—¥æˆåŠŸæ ‡å‡†**

### **ç¼–è¯‘å’Œè¿è¡Œ**
- [ ] æœåŠ¡ç¼–è¯‘é€šè¿‡ (0 errors, 0 warnings)
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ (ç«¯å£8081)
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡ (/health endpoint)

### **åŠŸèƒ½éªŒè¯**
- [ ] Binance WebSocketè¿æ¥æˆåŠŸ
- [ ] å®æ—¶æ•°æ®æ¥æ”¶å’Œå¤„ç†
- [ ] ClickHouseæ•°æ®å†™å…¥æˆåŠŸ
- [ ] Redisç¼“å­˜æ›´æ–°æ­£å¸¸

### **è´¨é‡æŒ‡æ ‡**
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†è¾¾æ ‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ğŸ“ **åä½œæ¥å£**

### **ä¾èµ–æœåŠ¡**
- **ClickHouse**: æ—¶åºæ•°æ®å­˜å‚¨
- **Redis**: å®æ—¶æ•°æ®ç¼“å­˜
- **Kafka**: æ¶ˆæ¯é˜Ÿåˆ—å‘å¸ƒ

### **æœåŠ¡æ¶ˆè´¹è€…**
- **Trading Engine**: å®æ—¶ä»·æ ¼æ•°æ®
- **Strategy Engine**: å†å²å’Œå®æ—¶æ•°æ®
- **Frontend**: å¸‚åœºæ•°æ®å±•ç¤º

### **æ²Ÿé€šèŠ‚ç‚¹**
- **æ¶æ„å¸ˆ**: æŠ€æœ¯æ–¹æ¡ˆç¡®è®¤
- **è¿ç»´**: æ•°æ®åº“è¿æ¥å’Œé…ç½®
- **å‰ç«¯**: APIæ¥å£å¯¹æ¥

---

**è´Ÿè´£äºº**: Market Data Engineer  
**å®Œæˆæ—¶é—´**: ä»Šæ—¥18:00å‰  
**è´¨é‡æ ‡å‡†**: æ¶æ„å¸ˆå®¡æŸ¥é€šè¿‡