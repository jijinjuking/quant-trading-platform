# 🚀 企业级量化交易平台开发大纲

## 📋 核心开发原则

### ⚠️ 关键约束条件
1. **文件行数限制**: 每个源代码文件不得超过 **800行**
2. **模块化设计**: 大功能必须拆分为多个小模块
3. **单一职责**: 每个文件只负责一个明确的功能
4. **可维护性**: 代码结构清晰，易于理解和修改
5. **测试文件清理**: 测试完成后必须立即清理测试文件，保持系统干净整洁

### 🏗️ 模块化策略
- 当文件接近600行时，开始考虑拆分
- 按功能域拆分：配置、处理器、服务、工具等
- 使用 `mod.rs` 文件组织子模块
- 通过 `pub use` 重新导出常用类型

### 📁 文件组织规范
```
service/
├── src/
│   ├── main.rs              (< 100行，仅启动逻辑)
│   ├── config/              (配置相关)
│   │   ├── mod.rs
│   │   ├── server.rs        (< 200行)
│   │   ├── database.rs      (< 200行)
│   │   └── auth.rs          (< 200行)
│   ├── handlers/            (请求处理器)
│   │   ├── mod.rs
│   │   ├── auth.rs          (< 300行)
│   │   ├── trading.rs       (< 300行)
│   │   └── market.rs        (< 300行)
│   ├── services/            (业务服务)
│   │   ├── mod.rs
│   │   ├── user_service.rs  (< 400行)
│   │   └── trade_service.rs (< 400行)
│   ├── middleware/          (中间件)
│   │   ├── mod.rs
│   │   ├── auth.rs          (< 200行)
│   │   └── rate_limit.rs    (< 200行)
│   └── utils/               (工具函数)
│       ├── mod.rs
│       ├── validation.rs    (< 300行)
│       └── crypto.rs        (< 300行)
```

## 🎯 开发流程

### 1. 架构设计阶段
- 明确服务边界和职责
- 设计API接口和数据模型
- 规划模块结构和文件组织

### 2. 编码实现阶段
- 先创建模块骨架（mod.rs文件）
- 实现核心功能，控制文件大小
- 及时拆分超长文件

### 3. 代码审查阶段
- 检查文件行数是否超限
- 验证模块职责是否单一
- 确保代码可读性和可维护性

## 📊 质量标准

### 代码质量指标
- 文件行数: ≤ 800行 ✅
- 函数长度: ≤ 50行
- 圈复杂度: ≤ 10
- 测试覆盖率: ≥ 80%

### 性能要求
- API响应时间: < 100ms
- 内存使用: < 512MB
- CPU使用率: < 50%
- 并发连接: > 1000

## 🔧 技术栈规范

### 后端技术
- **语言**: Rust 1.70+
- **框架**: Axum 0.7+
- **数据库**: PostgreSQL + Redis + ClickHouse
- **消息队列**: Apache Kafka
- **监控**: Prometheus + Grafana

### 前端技术
- **框架**: Vue 3 + TypeScript
- **UI库**: Element Plus
- **图表**: TradingView Charting Library
- **构建**: Vite

## 🌐 服务端口分配 (正式版本 - 2024年12月21日更新)

### 🚨 重要通知：端口分配已正式确定，所有开发人员必须严格遵守

| 服务名称 | 端口 | 状态 | 版本 | 备注 |
|---------|------|------|------|------|
| user-management | 8083 | ✅ 运行中 | 专业版 | 用户管理服务 |
| market-data | 8081 | ✅ 运行中 | 专业版 | 市场数据服务 |
| **trading-engine** | **8087** | ✅ 运行中 | 专业版 | **交易引擎 - 端口已确定** |
| strategy-engine | 9001 | 🔄 配置中 | 专业版 | 策略引擎服务 |
| risk-management | 8085 | ✅ 运行中 | 专业版 | 风险管理服务 |
| notification | 8086 | ✅ 运行中 | 专业版 | 通知服务 |
| **analytics** | **8088** | ✅ 修复完成 | 专业版 | **分析服务 - 端口已调整** |
| ai-service | 8089 | 📋 计划中 | 专业版 | AI服务 |

### 🔥 关键变更说明
1. **trading-engine端口**: 从8082正式变更为**8087**
2. **analytics端口**: 从8087调整为**8088**，解决端口冲突
3. **所有配置文件**: 必须更新为新的端口分配
4. **前端API调用**: 必须更新trading-engine端点为8087

### 📋 开发人员行动清单
- [ ] **前端团队**: 更新所有API调用中的端口配置
- [ ] **后端团队**: 更新服务间通信端口配置  
- [ ] **DevOps团队**: 更新部署脚本和监控配置
- [ ] **测试团队**: 更新测试脚本中的端口配置

### 🚫 严禁事项
- ❌ 不得随意修改已确定的端口分配
- ❌ 不得在代码中硬编码端口号
- ❌ 不得使用冲突的端口进行测试

### ✅ 标准配置方式
```bash
# 环境变量配置 (.env.database)
TRADING_ENGINE_PORT=8087
ANALYTICS_PORT=8088
STRATEGY_ENGINE_PORT=9001
```

```rust
// Rust代码中的标准端口配置
let port = std::env::var("SERVICE_NAME_PORT")
    .unwrap_or_else(|_| "DEFAULT_PORT".to_string())
    .parse::<u16>()
    .unwrap_or(DEFAULT_PORT);
```

## 🧹 测试文件管理规范

### 测试文件清理原则
- **即时清理**: 测试完成后立即删除测试文件
- **自动化清理**: 使用脚本自动清理临时文件
- **版本控制**: 测试文件不得提交到版本库
- **命名规范**: 测试文件使用 `test_*` 或 `*.test.*` 命名

### 清理检查清单
```bash
# 清理命令示例
find . -name "test_*" -type f -delete
find . -name "*.test.*" -type f -delete
find . -name "*.tmp" -type f -delete
find . -name "debug.log" -type f -delete
```

### 禁止保留的文件类型
- 临时测试文件 (`*.tmp`, `*.test`)
- 调试日志文件 (`debug.log`, `*.debug`)
- 备份文件 (`*.bak`, `*.backup`)
- 编译产物测试文件

## 📝 编码规范

### Rust代码规范
```rust
// 1. 模块导入顺序
use std::collections::HashMap;
use anyhow::Result;
use axum::extract::State;
use shared_models::User;

// 2. 结构体定义
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UserService {
    config: UserConfig,
    database: Arc<Database>,
}

// 3. 实现块组织
impl UserService {
    // 构造函数
    pub fn new(config: UserConfig) -> Self { }
    
    // 公共方法
    pub async fn create_user(&self) -> Result<User> { }
    
    // 私有方法
    async fn validate_user(&self) -> Result<()> { }
}

// 4. 错误处理
pub type ServiceResult<T> = Result<T, ServiceError>;
```

### 文件拆分示例
```rust
// 原文件过长时的拆分策略

// config/mod.rs
pub mod server;
pub mod database;
pub mod auth;

pub use server::ServerConfig;
pub use database::DatabaseConfig;
pub use auth::AuthConfig;

// config/server.rs (< 200行)
#[derive(Debug, Clone)]
pub struct ServerConfig {
    pub host: String,
    pub port: u16,
}

// config/database.rs (< 200行)
#[derive(Debug, Clone)]
pub struct DatabaseConfig {
    pub url: String,
    pub pool_size: u32,
}
```

## 🚦 开发检查清单

### 每次提交前检查
- [ ] 所有文件行数 ≤ 800行
- [ ] 模块职责单一明确
- [ ] 代码格式化完成
- [ ] 单元测试通过
- [ ] 文档注释完整
- [ ] 测试文件已清理完毕
- [ ] 临时文件已删除

### 每个功能完成后检查
- [ ] API接口设计合理
- [ ] 错误处理完善
- [ ] 性能指标达标
- [ ] 安全性验证通过

## 🎯 里程碑规划

### Phase 1: 基础架构 (Week 1-2)
- [x] 共享库开发 (models, utils, protocols)
- [x] API网关服务基础框架
- [ ] 完成网关核心功能

### Phase 2: 核心服务 (Week 3-6)
- [ ] 市场数据服务
- [ ] 交易引擎服务  
- [ ] 用户管理服务
- [ ] 策略引擎服务

### Phase 3: 高级功能 (Week 7-10)
- [ ] 风险管理服务
- [ ] 通知服务
- [ ] 分析服务
- [ ] 前端应用

### Phase 4: 优化部署 (Week 11-12)
- [ ] 性能优化
- [ ] 安全加固
- [ ] 监控完善
- [ ] 生产部署

---

**重要提醒**: 严格遵守800行限制，这是保证代码质量和可维护性的关键约束！