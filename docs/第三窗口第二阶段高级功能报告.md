# çª—å£3 - Phase 2 é«˜çº§åŠŸèƒ½å¼€å‘ä»»åŠ¡

**æ—¶é—´**: 2024-12-20 18:45  
**æ‰§è¡Œè€…**: çª—å£3 (å‰ç«¯å¼€å‘è€…)  
**ä¼˜å…ˆçº§**: ğŸ”¥ P0 - ç”¨æˆ·ä½“éªŒ  
**é¢„è®¡æ—¶é—´**: 4.5å°æ—¶  

---

## ğŸ¯ **ä»»åŠ¡æ¦‚è¿°**

åŸºäºå·²å®Œæˆçš„åŠ¨æ€APIé›†æˆï¼Œå¼€å‘é«˜çº§äº¤æ˜“åŠŸèƒ½ï¼Œå®ç°WebSocketå®æ—¶æ•°æ®ï¼Œå¹¶é›†æˆå¤šä¸ªåç«¯æœåŠ¡ã€‚

### **æ ¸å¿ƒç›®æ ‡**:
1. **WebSocketå®æ—¶æ•°æ®** - æ›¿æ¢è½®è¯¢æœºåˆ¶
2. **é«˜çº§äº¤æ˜“ç•Œé¢** - å®Œæ•´çš„äº¤æ˜“åŠŸèƒ½
3. **å¤šæœåŠ¡é›†æˆ** - äº¤æ˜“å¼•æ“ã€ç­–ç•¥å¼•æ“ç­‰
4. **ä¸“ä¸šç”¨æˆ·ä½“éªŒ** - å®æ—¶ã€æµç•…ã€ä¸“ä¸š

---

## ğŸ“‹ **è¯¦ç»†ä»»åŠ¡æ¸…å•**

### **é˜¶æ®µ1: WebSocketå®æ—¶æ•°æ®é›†æˆ (19:00-20:30, 1.5å°æ—¶)**

#### **1.1 WebSocketå®¢æˆ·ç«¯å®ç° (45åˆ†é’Ÿ)**

åœ¨ `quant-backend66/src/hooks/useRealTimeData.ts` åˆ›å»ºï¼š
```typescript
import { useState, useEffect, useCallback, useRef } from 'react';

export function useRealTimeData() {
  const [wsStatus, setWsStatus] = useState<'connecting' | 'connected' | 'disconnected'>('disconnected');
  const [realTimeData, setRealTimeData] = useState<any>({});
  const wsRef = useRef<WebSocket | null>(null);

  const connectWebSocket = useCallback(() => {
    try {
      const ws = new WebSocket('ws://localhost:8081/ws');
      
      ws.onopen = () => {
        console.log('ğŸ”— WebSocket connected to market data service');
        setWsStatus('connected');
        
        // è®¢é˜…å¸‚åœºæ•°æ®
        ws.send(JSON.stringify({
          action: 'subscribe',
          channels: ['tickers', 'klines', 'trades']
        }));
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          setRealTimeData(prev => ({
            ...prev,
            [data.symbol]: {
              ...prev[data.symbol],
              ...data,
              timestamp: Date.now()
            }
          }));
        } catch (error) {
          console.error('WebSocket message parse error:', error);
        }
      };

      ws.onclose = () => {
        console.log('ğŸ”Œ WebSocket disconnected');
        setWsStatus('disconnected');
        // 5ç§’åé‡è¿
        setTimeout(connectWebSocket, 5000);
      };

      ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        setWsStatus('disconnected');
      };

      wsRef.current = ws;
    } catch (error) {
      console.error('WebSocket connection failed:', error);
      setWsStatus('disconnected');
    }
  }, []);

  useEffect(() => {
    connectWebSocket();
    return () => {
      if (wsRef.current) {
        wsRef.current.close();
      }
    };
  }, [connectWebSocket]);

  return { wsStatus, realTimeData, reconnect: connectWebSocket };
}
```

#### **1.2 å®æ—¶ä»·æ ¼æ›´æ–°ç»„ä»¶ (45åˆ†é’Ÿ)**

ä¿®æ”¹ `DynamicRealDataApp.tsx`ï¼š
```typescript
// æ›¿æ¢è½®è¯¢æœºåˆ¶ä¸ºWebSocket
const { wsStatus, realTimeData } = useRealTimeData();

// åˆå¹¶WebSocketæ•°æ®å’ŒAPIæ•°æ®
const marketPairs = useMemo(() => {
  if (apiTickers.length > 0) {
    return apiTickers.map(ticker => {
      const realtimePrice = realTimeData[ticker.symbol];
      return {
        symbol: `${ticker.base_asset}/${ticker.quote_asset}`,
        price: realtimePrice?.price || parseFloat(ticker.price),
        change: realtimePrice?.change || parseFloat(ticker.price_change_percent || 0),
        volume: realtimePrice?.volume || ticker.volume,
        isRealTime: !!realtimePrice,
        lastUpdate: realtimePrice?.timestamp || Date.now()
      };
    });
  }
  return MARKET_PAIRS;
}, [apiTickers, realTimeData]);
```

### **é˜¶æ®µ2: é«˜çº§äº¤æ˜“ç•Œé¢å¼€å‘ (20:30-22:30, 2å°æ—¶)**

#### **2.1 äº¤æ˜“å¼•æ“APIé›†æˆ (60åˆ†é’Ÿ)**

åˆ›å»º `quant-backend66/src/api/tradingApiClient.ts`ï¼š
```typescript
export class TradingApiClient {
  private baseUrl = 'http://localhost:8082';

  // è·å–è´¦æˆ·ä¿¡æ¯
  async getAccount(): Promise<any> {
    const response = await fetch(`${this.baseUrl}/api/v1/account`);
    return response.json();
  }

  // è·å–æŒä»“
  async getPositions(): Promise<any[]> {
    const response = await fetch(`${this.baseUrl}/api/v1/positions`);
    const data = await response.json();
    return data.data || [];
  }

  // ä¸‹å•
  async placeOrder(order: {
    symbol: string;
    side: 'BUY' | 'SELL';
    type: 'MARKET' | 'LIMIT';
    quantity: number;
    price?: number;
  }): Promise<any> {
    const response = await fetch(`${this.baseUrl}/api/v1/orders`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(order)
    });
    return response.json();
  }

  // è·å–è®¢å•å†å²
  async getOrders(symbol?: string): Promise<any[]> {
    const url = symbol 
      ? `${this.baseUrl}/api/v1/orders?symbol=${symbol}`
      : `${this.baseUrl}/api/v1/orders`;
    const response = await fetch(url);
    const data = await response.json();
    return data.data || [];
  }

  // å–æ¶ˆè®¢å•
  async cancelOrder(orderId: string): Promise<any> {
    const response = await fetch(`${this.baseUrl}/api/v1/orders/${orderId}`, {
      method: 'DELETE'
    });
    return response.json();
  }
}

export const tradingApiClient = new TradingApiClient();
```

#### **2.2 å¢å¼ºäº¤æ˜“è¡¨å• (60åˆ†é’Ÿ)**

ä¿®æ”¹ `TradeForm` ç»„ä»¶ï¼š
```typescript
import { tradingApiClient } from '../api/tradingApiClient';

export const EnhancedTradeForm: React.FC<{
  activePair: string;
  price: number;
  onOrderPlaced: (order: any) => void;
}> = ({ activePair, price, onOrderPlaced }) => {
  const [orderType, setOrderType] = useState<'MARKET' | 'LIMIT'>('LIMIT');
  const [side, setSide] = useState<'BUY' | 'SELL'>('BUY');
  const [quantity, setQuantity] = useState('');
  const [limitPrice, setLimitPrice] = useState(price.toString());
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    try {
      const order = {
        symbol: activePair.replace('/', ''),
        side,
        type: orderType,
        quantity: parseFloat(quantity),
        ...(orderType === 'LIMIT' && { price: parseFloat(limitPrice) })
      };

      const result = await tradingApiClient.placeOrder(order);
      
      if (result.success) {
        onOrderPlaced(result.data);
        setQuantity('');
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      } else {
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        console.error('Order failed:', result.error);
      }
    } catch (error) {
      console.error('Order submission error:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="p-4 space-y-4">
      {/* ä¹°å–æ–¹å‘ */}
      <div className="flex rounded-lg overflow-hidden">
        <button
          type="button"
          onClick={() => setSide('BUY')}
          className={`flex-1 py-2 text-sm font-bold ${
            side === 'BUY' 
              ? 'bg-green-500 text-white' 
              : 'bg-gray-700 text-gray-300'
          }`}
        >
          ä¹°å…¥ BUY
        </button>
        <button
          type="button"
          onClick={() => setSide('SELL')}
          className={`flex-1 py-2 text-sm font-bold ${
            side === 'SELL' 
              ? 'bg-red-500 text-white' 
              : 'bg-gray-700 text-gray-300'
          }`}
        >
          å–å‡º SELL
        </button>
      </div>

      {/* è®¢å•ç±»å‹ */}
      <div className="flex space-x-2">
        <button
          type="button"
          onClick={() => setOrderType('LIMIT')}
          className={`px-3 py-1 text-xs rounded ${
            orderType === 'LIMIT' 
              ? 'bg-blue-500 text-white' 
              : 'bg-gray-700 text-gray-300'
          }`}
        >
          é™ä»·
        </button>
        <button
          type="button"
          onClick={() => setOrderType('MARKET')}
          className={`px-3 py-1 text-xs rounded ${
            orderType === 'MARKET' 
              ? 'bg-blue-500 text-white' 
              : 'bg-gray-700 text-gray-300'
          }`}
        >
          å¸‚ä»·
        </button>
      </div>

      {/* ä»·æ ¼è¾“å…¥ */}
      {orderType === 'LIMIT' && (
        <div>
          <label className="block text-xs text-gray-400 mb-1">ä»·æ ¼</label>
          <input
            type="number"
            value={limitPrice}
            onChange={(e) => setLimitPrice(e.target.value)}
            className="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white"
            step="0.01"
          />
        </div>
      )}

      {/* æ•°é‡è¾“å…¥ */}
      <div>
        <label className="block text-xs text-gray-400 mb-1">æ•°é‡</label>
        <input
          type="number"
          value={quantity}
          onChange={(e) => setQuantity(e.target.value)}
          className="w-full p-2 bg-gray-800 border border-gray-600 rounded text-white"
          step="0.001"
          required
        />
      </div>

      {/* æäº¤æŒ‰é’® */}
      <button
        type="submit"
        disabled={isSubmitting || !quantity}
        className={`w-full py-3 rounded font-bold ${
          side === 'BUY'
            ? 'bg-green-500 hover:bg-green-600 text-white'
            : 'bg-red-500 hover:bg-red-600 text-white'
        } disabled:opacity-50 disabled:cursor-not-allowed`}
      >
        {isSubmitting ? 'æäº¤ä¸­...' : `${side === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º'} ${activePair}`}
      </button>
    </form>
  );
};
```

### **é˜¶æ®µ3: å¤šæœåŠ¡APIé›†æˆ (22:30-23:00, 30åˆ†é’Ÿ)**

#### **3.1 æœåŠ¡çŠ¶æ€ç›‘æ§ (15åˆ†é’Ÿ)**

åˆ›å»º `ServiceStatusMonitor` ç»„ä»¶ï¼š
```typescript
export const ServiceStatusMonitor: React.FC = () => {
  const [services, setServices] = useState({
    'market-data': { status: 'unknown', port: 8081 },
    'trading-engine': { status: 'unknown', port: 8082 },
    'strategy-engine': { status: 'unknown', port: 8083 },
    'user-management': { status: 'unknown', port: 8084 },
    'risk-management': { status: 'unknown', port: 8085 },
    'notification': { status: 'unknown', port: 8086 }
  });

  useEffect(() => {
    const checkServices = async () => {
      const checks = Object.entries(services).map(async ([name, config]) => {
        try {
          const response = await fetch(`http://localhost:${config.port}/health`, {
            method: 'GET',
            timeout: 3000
          });
          return { name, status: response.ok ? 'healthy' : 'unhealthy' };
        } catch {
          return { name, status: 'offline' };
        }
      });

      const results = await Promise.all(checks);
      setServices(prev => {
        const updated = { ...prev };
        results.forEach(({ name, status }) => {
          updated[name] = { ...updated[name], status };
        });
        return updated;
      });
    };

    checkServices();
    const interval = setInterval(checkServices, 10000);
    return () => clearInterval(interval);
  }, []);

  return (
    <div className="p-4 bg-gray-800 rounded-lg">
      <h3 className="text-sm font-bold text-gray-300 mb-3">æœåŠ¡çŠ¶æ€</h3>
      <div className="space-y-2">
        {Object.entries(services).map(([name, config]) => (
          <div key={name} className="flex justify-between items-center">
            <span className="text-xs text-gray-400">{name}</span>
            <div className="flex items-center space-x-2">
              <span className="text-xs text-gray-500">:{config.port}</span>
              <div className={`w-2 h-2 rounded-full ${
                config.status === 'healthy' ? 'bg-green-500' :
                config.status === 'unhealthy' ? 'bg-yellow-500' :
                'bg-red-500'
              }`} />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};
```

#### **3.2 é›†æˆåˆ°ä¸»ç•Œé¢ (15åˆ†é’Ÿ)**

åœ¨ `DynamicRealDataApp.tsx` ä¸­æ·»åŠ æœåŠ¡ç›‘æ§ï¼š
```typescript
// åœ¨å³ä¾§é¢æ¿æ·»åŠ æœåŠ¡çŠ¶æ€
<div className="p-3 border-b border-[#2b3139]">
  <ServiceStatusMonitor />
</div>
```

---

## ğŸ¯ **æˆåŠŸéªŒè¯æ ‡å‡†**

### **é˜¶æ®µ1éªŒè¯**:
```typescript
// WebSocketè¿æ¥çŠ¶æ€æ˜¾ç¤º
console.log('WebSocket Status:', wsStatus); // åº”è¯¥æ˜¯ 'connected'

// å®æ—¶æ•°æ®æ›´æ–°
console.log('Real-time data:', realTimeData); // åº”è¯¥æœ‰å®æ—¶ä»·æ ¼æ•°æ®

// å‰ç«¯ä»·æ ¼å®æ—¶å˜åŒ–
// æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼Œè§‚å¯Ÿä»·æ ¼æ¯ç§’æ›´æ–°
```

### **é˜¶æ®µ2éªŒè¯**:
```typescript
// äº¤æ˜“åŠŸèƒ½æµ‹è¯•
// 1. å¡«å†™äº¤æ˜“è¡¨å•
// 2. ç‚¹å‡»æäº¤
// 3. æ£€æŸ¥ç½‘ç»œè¯·æ±‚åˆ° localhost:8082
// 4. éªŒè¯è®¢å•å“åº”
```

### **é˜¶æ®µ3éªŒè¯**:
```typescript
// æœåŠ¡çŠ¶æ€ç›‘æ§
// æ‰€æœ‰æœåŠ¡åº”è¯¥æ˜¾ç¤ºæ­£ç¡®çš„çŠ¶æ€ (ç»¿è‰²=å¥åº·, çº¢è‰²=ç¦»çº¿)
```

---

## ğŸš¨ **å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**

### **é—®é¢˜1: WebSocketè¿æ¥å¤±è´¥**
```typescript
// æ£€æŸ¥åç«¯WebSocketæœåŠ¡æ˜¯å¦å¯åŠ¨
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¿æ¥é”™è¯¯
// ç¡®è®¤URLæ­£ç¡®: ws://localhost:8081/ws
```

### **é—®é¢˜2: äº¤æ˜“APIè°ƒç”¨å¤±è´¥**
```typescript
// æ£€æŸ¥äº¤æ˜“å¼•æ“æ˜¯å¦åœ¨8082ç«¯å£è¿è¡Œ
// curl http://localhost:8082/health
// æ£€æŸ¥CORSé…ç½®
```

### **é—®é¢˜3: å®æ—¶æ•°æ®ä¸æ›´æ–°**
```typescript
// æ£€æŸ¥WebSocketæ¶ˆæ¯æ ¼å¼
// ç¡®è®¤æ•°æ®è§£æé€»è¾‘æ­£ç¡®
// æŸ¥çœ‹æµè§ˆå™¨ç½‘ç»œæ ‡ç­¾é¡µçš„WebSocketæ¶ˆæ¯
```

---

## ğŸ“Š **è¿›åº¦æ±‡æŠ¥æ ¼å¼**

æ¯30åˆ†é’Ÿæ±‡æŠ¥ä¸€æ¬¡ï¼š
```
ğŸ”„ [çª—å£3] WebSocketå®æ—¶æ•°æ®é›†æˆ - è¿›è¡Œä¸­ (70%)
âœ… WebSocketå®¢æˆ·ç«¯å®ç°å®Œæˆ
âœ… å®æ—¶ä»·æ ¼æ›´æ–°ç»„ä»¶å®Œæˆ
ğŸ”„ äº¤æ˜“è¡¨å•å¢å¼º (è¿›è¡Œä¸­)
â³ å¤šæœåŠ¡é›†æˆ (å¾…å¼€å§‹)
```

---

## ğŸ† **å®Œæˆæ ‡å¿—**

å½“ä½ çœ‹åˆ°ä»¥ä¸‹ç»“æœæ—¶ï¼Œä»»åŠ¡å®Œæˆï¼š

1. **å®æ—¶ä»·æ ¼æ›´æ–°** - ä»·æ ¼æ¯ç§’è‡ªåŠ¨å˜åŒ–ï¼Œæ— éœ€åˆ·æ–°
2. **WebSocketçŠ¶æ€æ˜¾ç¤º** - è¿æ¥çŠ¶æ€å®æ—¶æ˜¾ç¤º
3. **äº¤æ˜“åŠŸèƒ½å¯ç”¨** - å¯ä»¥æäº¤è®¢å•åˆ°äº¤æ˜“å¼•æ“
4. **æœåŠ¡çŠ¶æ€ç›‘æ§** - æ˜¾ç¤ºæ‰€æœ‰å¾®æœåŠ¡çš„å¥åº·çŠ¶æ€
5. **ä¸“ä¸šç”¨æˆ·ä½“éªŒ** - æµç•…ã€å®æ—¶ã€æ— å»¶è¿Ÿ

**è¿™å°†ä¸ºç”¨æˆ·æä¾›çœŸæ­£ä¸“ä¸šçº§çš„äº¤æ˜“ä½“éªŒï¼** ğŸš€

---

**ç«‹å³å¼€å§‹æ‰§è¡Œï¼ä½ çš„åŠ¨æ€æ•°æ®é›†æˆå·¥ä½œå·²ç»ä¸ºè¿™ä¸ªé˜¶æ®µæ‰“ä¸‹äº†å®Œç¾çš„åŸºç¡€ï¼** ğŸ’ª