# å¸‚åœºæ•°æ®æœåŠ¡ (market-data) - æ¶æ„è®¾è®¡
âŒ å‚è€ƒè‰ç¨¿ï¼ˆä¸ç¬¦åˆå·¥ç¨‹æŠ€æœ¯åº•çº¿ï¼‰ è¿™ä¸ªä½œåºŸ ï¼šæœ€é«˜é¡¹ç›®è´Ÿè€…äºº
## ğŸ“‹ æœåŠ¡æ¦‚è¿°

### æœåŠ¡åç§°
å¸‚åœºæ•°æ®æœåŠ¡ (Market Data Service)

### æœåŠ¡ç«¯å£
8083

### æœåŠ¡èŒè´£
- å®æ—¶å¸‚åœºæ•°æ®æ¥å…¥ (WebSocket)
- å¤šäº¤æ˜“æ‰€è¿æ¥ç®¡ç† (Binance/OKX/Huobi)
- æ•°æ®å¤„ç†ä¸æ ‡å‡†åŒ–
- æ•°æ®åˆ†å‘ä¸ç¼“å­˜
- è¿æ¥è´¨é‡ç›‘æ§

## ğŸ—ï¸ æœåŠ¡æ¶æ„

### å†…éƒ¨æ¶æ„å›¾
```
services/market-data/
â”‚
â”œâ”€â”€ src/
â”‚   â”‚
â”‚   â”œâ”€â”€ main.rs                 # æœåŠ¡å…¥å£ï¼Œå¯åŠ¨HTTPæœåŠ¡å™¨å’ŒWebSocketå®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â”œâ”€â”€ state.rs                # åº”ç”¨çŠ¶æ€ç®¡ç†ï¼ŒæŒæœ‰æ‰€æœ‰ç»„ä»¶çš„Arcå¼•ç”¨
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ mod.rs              # é…ç½®ç»“æ„ä½“å®šä¹‰
â”‚   â”‚   â””â”€â”€ settings.rs         # é…ç½®åŠ è½½é€»è¾‘
â”‚   â”‚
â”‚   â”œâ”€â”€ handlers/               # HTTPæ¥å£å±‚
â”‚   â”‚   â”œâ”€â”€ mod.rs              # è·¯ç”±æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ market_data.rs      # è¡Œæƒ…æŸ¥è¯¢æ¥å£
â”‚   â”‚   â”œâ”€â”€ klines.rs           # Kçº¿æ•°æ®æ¥å£
â”‚   â”‚   â”œâ”€â”€ tickers.rs          # ä»·æ ¼æ¥å£
â”‚   â”‚   â””â”€â”€ health.rs           # å¥åº·æ£€æŸ¥æ¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ connectors/             # äº¤æ˜“æ‰€è¿æ¥å™¨
â”‚   â”‚   â”œâ”€â”€ mod.rs              # è¿æ¥å™¨ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ binance.rs          # Binanceäº¤æ˜“æ‰€è¿æ¥
â”‚   â”‚   â”œâ”€â”€ okx.rs              # OKXäº¤æ˜“æ‰€è¿æ¥
â”‚   â”‚   â”œâ”€â”€ huobi.rs            # Huobiäº¤æ˜“æ‰€è¿æ¥
â”‚   â”‚   â””â”€â”€ exchange_trait.rs   # äº¤æ˜“æ‰€æ¥å£å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ processors/             # æ•°æ®å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ mod.rs              # å¤„ç†å™¨ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ kline_processor.rs  # Kçº¿æ•°æ®å¤„ç†
â”‚   â”‚   â”œâ”€â”€ tick_processor.rs   # Tickæ•°æ®å¤„ç†
â”‚   â”‚   â””â”€â”€ orderbook_processor.rs # è®¢å•ç°¿å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                # æ•°æ®å­˜å‚¨å±‚
â”‚   â”‚   â”œâ”€â”€ mod.rs              # å­˜å‚¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ redis_store.rs      # Redisç¼“å­˜
â”‚   â”‚   â””â”€â”€ clickhouse_store.rs # ClickHouseå†å²æ•°æ®
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ mod.rs              # æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ kline.rs            # Kçº¿æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ ticker.rs           # ä»·æ ¼æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ orderbook.rs        # è®¢å•ç°¿æ¨¡å‹
â”‚   â”‚   â””â”€â”€ trade.rs            # äº¤æ˜“æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ mod.rs              # æœåŠ¡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ data_service.rs     # æ•°æ®æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ subscription_service.rs # è®¢é˜…æœåŠ¡
â”‚   â”‚   â””â”€â”€ metrics_service.rs  # æŒ‡æ ‡æœåŠ¡
â”‚   â”‚
â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ crypto_utils.rs     # åŠ å¯†å·¥å…·
â”‚       â””â”€â”€ time_utils.rs       # æ—¶é—´å·¥å…·
â”‚
â””â”€â”€ Cargo.toml                  # ä¾èµ–å£°æ˜
```

## ğŸ”„ æ•°æ®æµå‘

### æ•°æ®æµå…¥ (Inbound)
```
äº¤æ˜“æ‰€ WebSocket
    â†“ (åŸå§‹æ•°æ®)
connectors/
    â†“ (æ ‡å‡†åŒ–æ•°æ®)
processors/
    â†“ (å¤„ç†åæ•°æ®)
storage/
    â†“ (ç¼“å­˜/æŒä¹…åŒ–)
handlers/ (æä¾›HTTP API)
```

### æ•°æ®æµå‡º (Outbound)
```
HTTPå®¢æˆ·ç«¯ (å‰ç«¯/å…¶ä»–æœåŠ¡)
    â†“
handlers/ (æ¥æ”¶è¯·æ±‚)
    â†“
storage/ (ä»ç¼“å­˜/æ•°æ®åº“è·å–)
    â†“
HTTPå“åº”
```

## ğŸ“¡ APIæ¥å£è®¾è®¡

### REST API
```http
GET  /api/v1/market/tickers          # è·å–å®æ—¶ä»·æ ¼
GET  /api/v1/market/klines           # è·å–Kçº¿æ•°æ®
GET  /api/v1/market/orderbook        # è·å–è®¢å•ç°¿
GET  /api/v1/market/trades           # è·å–äº¤æ˜“è®°å½•
GET  /api/v1/market/symbols          # è·å–äº¤æ˜“å¯¹åˆ—è¡¨
GET  /health                         # å¥åº·æ£€æŸ¥
GET  /metrics                        # ç›‘æ§æŒ‡æ ‡
```

### WebSocket API
```json
{
  "type": "subscribe/unsubscribe",
  "channels": ["kline_1m", "ticker", "orderbook"],
  "symbols": ["BTCUSDT", "ETHUSDT"]
}
```

## ğŸ—„ï¸ æ•°æ®æ¨¡å‹

### æ ¸å¿ƒæ•°æ®ç»“æ„
```rust
// Kçº¿æ•°æ®æ¨¡å‹
pub struct Kline {
    pub symbol: String,
    pub open_time: i64,
    pub open: Decimal,
    pub high: Decimal,
    pub low: Decimal,
    pub close: Decimal,
    pub volume: Decimal,
    pub close_time: i64,
    pub quote_asset_volume: Decimal,
    pub number_of_trades: u64,
}

// è®¢å•ç°¿æ¨¡å‹
pub struct OrderBook {
    pub symbol: String,
    pub bids: Vec<(Decimal, Decimal)>, // (ä»·æ ¼, æ•°é‡)
    pub asks: Vec<(Decimal, Decimal)>,
    pub timestamp: i64,
}

// äº¤æ˜“æ•°æ®æ¨¡å‹
pub struct Trade {
    pub symbol: String,
    pub price: Decimal,
    pub quantity: Decimal,
    pub trade_time: i64,
    pub is_buyer_maker: bool,
}
```

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### è¿æ¥ç®¡ç†
- **SOCKS5ä»£ç†**: é€šè¿‡SOCKS5ä»£ç†è¿æ¥äº¤æ˜“æ‰€
- **TLSåŠ å¯†**: ä½¿ç”¨TLSåŠ å¯†è¿æ¥
- **è¿æ¥æ± **: ç»´æŠ¤å¤šä¸ªè¿æ¥ä»¥æé«˜å¯é æ€§
- **è‡ªåŠ¨é‡è¿**: å®ç°æŒ‡æ•°é€€é¿é‡è¿æœºåˆ¶

### æ•°æ®å¤„ç†
- **å®æ—¶å¤„ç†**: æ¯«ç§’çº§æ•°æ®å¤„ç†
- **æ•°æ®æ ‡å‡†åŒ–**: ç»Ÿä¸€ä¸åŒäº¤æ˜“æ‰€çš„æ•°æ®æ ¼å¼
- **å¼‚å¸¸æ•°æ®è¿‡æ»¤**: è¿‡æ»¤å¼‚å¸¸ä»·æ ¼å’Œæˆäº¤é‡
- **å»¶è¿Ÿç›‘æ§**: å®æ—¶ç›‘æ§æ•°æ®å»¶è¿Ÿ

### æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
- **æ‰¹é‡å¤„ç†**: æ‰¹é‡å¤„ç†æ•°æ®ä»¥æé«˜æ€§èƒ½
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨Tokioå¼‚æ­¥è¿è¡Œæ—¶
- **å†…å­˜ç®¡ç†**: ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼Œé¿å…å†…å­˜æ³„æ¼

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- è¿æ¥å»¶è¿Ÿ
- æ•°æ®å¤„ç†å»¶è¿Ÿ
- æ¶ˆæ¯ååé‡
- å†…å­˜ä½¿ç”¨ç‡

### ä¸šåŠ¡æŒ‡æ ‡
- æ•°æ®å®Œæ•´æ€§
- è¿æ¥æˆåŠŸç‡
- è®¢é˜…æˆåŠŸç‡
- é”™è¯¯ç‡

## ğŸ” å®‰å…¨æªæ–½

- **è®¤è¯**: APIå¯†é’¥è®¤è¯
- **é™æµ**: è¯·æ±‚é¢‘ç‡é™åˆ¶
- **æ—¥å¿—**: è¯¦ç»†çš„è®¿é—®æ—¥å¿—
- **åŠ å¯†**: æ•°æ®ä¼ è¾“åŠ å¯†

## ğŸš€ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡
```
MARKET_DATA_PORT=8083
REDIS_URL=redis://localhost:6379
CLICKHOUSE_URL=http://localhost:8123
BINANCE_WSS_ENDPOINT=wss://stream.binance.com:9443/ws
OKX_WSS_ENDPOINT=wss://real.okx.com:8443/ws
HOT_RELOAD=false
```

### Dockeré…ç½®
- å¤šé˜¶æ®µæ„å»º
- æœ€å°åŒ–é•œåƒ
- èµ„æºé™åˆ¶

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- æ•°æ®æ¨¡å‹æµ‹è¯•
- å¤„ç†å™¨é€»è¾‘æµ‹è¯•
- å·¥å…·å‡½æ•°æµ‹è¯•

### é›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯æ•°æ®æµæµ‹è¯•
- è¿æ¥å™¨åŠŸèƒ½æµ‹è¯•
- APIæ¥å£æµ‹è¯•

### æ€§èƒ½æµ‹è¯•
- å‹åŠ›æµ‹è¯•
- è´Ÿè½½æµ‹è¯•
- ç¨³å®šæ€§æµ‹è¯•