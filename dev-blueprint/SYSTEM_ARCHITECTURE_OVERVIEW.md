# 量化交易平台 - 整体架构全景图

## 🎯 系统架构全景

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           量化交易平台 - 整体架构                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        【第一层：前端展示层】                              │   │
│  │                                                                         │   │
│  │   frontend/                                                             │   │
│  │   ├── src/                                                              │   │
│  │   │   ├── views/          # 页面组件 (Vue3)                             │   │
│  │   │   ├── components/     # 通用组件                                    │   │
│  │   │   ├── stores/         # 状态管理 (Pinia)                            │   │
│  │   │   ├── api/            # API 调用封装                                │   │
│  │   │   └── utils/          # 工具函数                                    │   │
│  │   └── vite.config.ts      # 构建配置                                    │   │
│  │                                                                         │   │
│  │   通讯方式: HTTP REST API + WebSocket (实时数据)                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        【第二层：API 网关层】                              │   │
│  │                                                                         │   │
│  │   services/gateway/                                                     │   │
│  │   ├── src/                                                              │   │
│  │   │   ├── main.rs         # 入口                                        │   │
│  │   │   ├── routes/         # 路由分发                                    │   │
│  │   │   ├── middleware/     # 中间件 (认证/限流/日志)                      │   │
│  │   │   └── proxy/          # 服务代理                                    │   │
│  │                                                                         │   │
│  │   职责: 统一入口、认证鉴权、负载均衡、请求路由                            │   │
│  │   端口: 8080                                                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                    ┌─────────────────┼─────────────────┐                       │
│                    ▼                 ▼                 ▼                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                     【第三层：业务服务层】(10个微服务)                      │   │
│  │                                                                         │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │   │
│  │  │ user-management  │  │  trading-engine  │  │  market-data     │      │   │
│  │  │ 用户管理服务      │  │  交易引擎服务     │  │  市场数据服务     │      │   │
│  │  │ 端口: 8081       │  │  端口: 8082       │  │  端口: 8083       │      │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘      │   │
│  │                                                                         │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │   │
│  │  │ strategy-engine  │  │ risk-management  │  │  notification    │      │   │
│  │  │ 策略引擎服务      │  │  风险管理服务     │  │  通知服务        │      │   │
│  │  │ 端口: 8084       │  │  端口: 8085       │  │  端口: 8086       │      │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘      │   │
│  │                                                                         │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │   │
│  │  │   analytics      │  │   ai-service     │  │  admin-backend   │      │   │
│  │  │  分析服务         │  │  AI 预测服务     │  │  管理后台服务     │      │   │
│  │  │  端口: 8087       │  │  端口: 8088       │  │  端口: 8089       │      │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘      │   │
│  │                                                                         │   │
│  │  服务间通讯: HTTP REST (同步) / Kafka (异步事件)                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                     【第四层：共享基础设施层】                              │   │
│  │                                                                         │   │
│  │   shared/                                                               │   │
│  │   ├── models/             # 共享数据模型 (跨服务通用结构体)               │   │
│  │   │   └── src/                                                          │   │
│  │   │       ├── user.rs     # 用户模型                                    │   │
│  │   │       ├── order.rs    # 订单模型                                    │   │
│  │   │       └── market.rs   # 市场数据模型                                │   │
│  │   │                                                                     │   │
│  │   ├── protocols/          # 通讯协议 (gRPC/WebSocket 定义)               │   │
│  │   │   └── src/                                                          │   │
│  │   │       ├── grpc.rs     # gRPC 服务定义                               │   │
│  │   │       └── websocket.rs# WebSocket 消息格式                          │   │
│  │   │                                                                     │   │
│  │   └── utils/              # 通用工具库                                   │   │
│  │       └── src/                                                          │   │
│  │           ├── config.rs   # 配置加载                                    │   │
│  │           ├── crypto.rs   # 加密工具                                    │   │
│  │           ├── http.rs     # HTTP 客户端                                 │   │
│  │           └── logging.rs  # 日志工具                                    │   │
│  │                                                                         │   │
│  │   职责: 提供跨服务复用的代码，避免重复                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                     【第五层：数据存储层】                                  │   │
│  │                                                                         │   │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │   │ PostgreSQL  │  │   Redis     │  │ ClickHouse  │  │   Kafka     │   │   │
│  │   │ 主数据库     │  │  缓存/会话   │  │  时序数据    │  │  消息队列    │   │   │
│  │   │ 端口: 5432  │  │  端口: 6379  │  │  端口: 8123  │  │  端口: 9092  │   │   │
│  │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  │                                                                         │   │
│  │   数据流向:                                                              │   │
│  │   - PostgreSQL: 用户/订单/策略等业务数据 (ACID 事务)                      │   │
│  │   - Redis: 会话缓存/实时状态/限流计数                                    │   │
│  │   - ClickHouse: K线/Tick/历史行情 (高性能时序查询)                        │   │
│  │   - Kafka: 服务间异步事件 (订单事件/行情推送/通知)                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 📦 单个服务内部架构 (以 notification 为例)

```
services/notification/
│
├── src/
│   │
│   ├── main.rs                 # 【入口层】程序启动、路由注册、服务器监听
│   │
│   ├── state.rs                # 【状态层】AppState - 依赖注入容器
│   │                           #   持有所有 Service 的 Arc<T> 引用
│   │
│   ├── config/                 # 【配置层】
│   │   └── mod.rs              #   加载环境变量、配置文件
│   │
│   ├── handlers/               # 【接口层 / Controller】
│   │   ├── mod.rs              #   HTTP 请求处理入口
│   │   ├── notifications.rs    #   /api/v1/notifications 路由
│   │   ├── templates.rs        #   /api/v1/templates 路由
│   │   ├── channels.rs         #   /api/v1/channels 路由
│   │   └── api/                #   前端专用 API
│   │       └── frontend_api.rs
│   │
│   ├── services/               # 【业务逻辑层 / Service】
│   │   ├── mod.rs              #   业务规则、流程编排
│   │   ├── notification_service.rs  # 通知核心逻辑
│   │   ├── template_service.rs      # 模板渲染逻辑
│   │   ├── channel_service.rs       # 渠道管理逻辑
│   │   ├── delivery_service.rs      # 投递执行逻辑
│   │   └── websocket_service.rs     # WebSocket 推送
│   │
│   ├── storage/                # 【数据访问层 / Repository】
│   │   ├── mod.rs              #   数据库 CRUD 操作
│   │   ├── notification_store.rs    # 通知表操作
│   │   ├── template_store.rs        # 模板表操作
│   │   ├── channel_store.rs         # 渠道配置表操作
│   │   └── delivery_store.rs        # 投递记录表操作
│   │
│   ├── models/                 # 【领域模型层 / Domain】
│   │   ├── mod.rs              #   数据结构定义
│   │   ├── notification.rs     #   Notification 实体 + 枚举
│   │   ├── template.rs         #   Template 实体
│   │   ├── channel.rs          #   Channel 配置
│   │   └── delivery.rs         #   投递记录
│   │
│   └── standards.rs            # 【规范层】AI 编码规范常量
│
└── Cargo.toml                  # 依赖声明
```

## 🔄 数据流向 & 层级调用关系

```
HTTP 请求
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  main.rs (入口)                                              │
│  - 启动 Tokio 运行时                                         │
│  - 创建 AppState (依赖注入)                                  │
│  - 注册路由 Router::new().route("/api/...", handler)        │
│  - 启动 axum::serve()                                       │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  handlers/ (接口层)                                          │
│  - 接收 HTTP 请求                                            │
│  - 解析参数 (Path, Query, Json)                             │
│  - 调用 Service 层                                          │
│  - 返回 JSON 响应                                           │
│                                                             │
│  async fn create_notification(                              │
│      State(state): State<AppState>,                         │
│      Json(request): Json<CreateNotificationRequest>,        │
│  ) -> Result<Json<Value>, StatusCode> {                     │
│      state.notification_service.create_notification(...)    │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  services/ (业务逻辑层)                                      │
│  - 业务规则校验                                              │
│  - 流程编排 (调用多个 Store)                                 │
│  - 事件发布 (Kafka)                                         │
│  - 不直接操作数据库                                          │
│                                                             │
│  impl NotificationService {                                  │
│      pub async fn create_notification(                       │
│          &self,                                              │
│          request: CreateNotificationRequest                 │
│      ) -> Result<Notification, Error> {                     │
│          // 1. 参数校验                                      │
│          // 2. 业务规则检查                                  │
│          // 3. 调用 Storage 层                              │
│          self.storage.create_notification(request).await?;   │
│          // 4. 发布事件 (Kafka)                             │
│          Ok(notification)                                    │
│      }                                                      │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  storage/ (数据访问层)                                       │
│  - 数据库 CRUD 操作                                         │
│  - SQL 语句执行                                             │
│  - 结果映射为 Domain Model                                  │
│                                                             │
│  impl NotificationStore {                                    │
│      pub async fn create_notification(                       │
│          &self,                                              │
│          notification: NewNotification                      │
│      ) -> Result<Notification, Error> {                     │
│          sqlx::query_as(                                     │
│              "INSERT INTO notifications ... RETURNING ..."  │
│          )                                                   │
│          .bind(&notification.title)                         │
│          .fetch_one(&self.pool)                             │
│          .await                                              │
│      }                                                      │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  PostgreSQL                                                │
│  - 持久化存储业务数据                                        │
│  - 保证 ACID 事务特性                                       │
│  - 支持复杂查询和关系操作                                    │
└─────────────────────────────────────────────────────────────┘
```

## 🌐 服务间通信机制

### 同步通信 (HTTP REST)
- API网关 → 业务服务
- 业务服务间直接调用
- 前端 → API网关

### 异步通信 (Kafka)
- 事件驱动架构
- 服务解耦
- 高可用性

### 实时通信 (WebSocket)
- 前端 ←→ 服务 (实时数据推送)
- 行情数据流
- 通知推送

## 🔧 技术栈概览

### 后端技术栈
- **语言**: Rust (高性能、内存安全)
- **框架**: Axum (异步Web框架)
- **运行时**: Tokio (异步运行时)
- **数据库**: Sqlx (编译时SQL检查)
- **RPC**: Tonic (gRPC框架)

### 前端技术栈
- **框架**: Vue 3 (响应式UI框架)
- **状态管理**: Pinia (轻量级状态管理)
- **构建工具**: Vite (快速构建工具)
- **UI组件**: 自定义组件库

### 基础设施
- **容器化**: Docker + Docker Compose
- **数据库**: PostgreSQL, Redis, ClickHouse
- **消息队列**: Kafka
- **监控**: Prometheus + Grafana
- **代理**: Nginx